# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an Android application built with Kotlin that demonstrates continuous integration and deployment using Jenkins. The project includes both the Android app source code and a complete Jenkins infrastructure for building, testing, and deploying the app to GitHub and Google Play Store.

## Build Commands

### Basic Gradle Commands

```bash
# Make gradlew executable (required on first use)
chmod +x ./gradlew

# Build the entire project
./gradlew build

# Build APKs and AABs
./gradlew :app:bundleDebug :app:bundleRelease

# Run unit tests
./gradlew test

# Run instrumented (Android) tests
./gradlew connectedAndroidTest

# Generate code coverage report
./gradlew jacocoTestReport
```

### Static Analysis

```bash
# Run Detekt with auto-correction
./gradlew detekt --auto-correct

# Run all checks (includes lint, SpotBugs, PMD, Detekt)
./gradlew check
```

### Clean Build

```bash
./gradlew clean build
```

## Jenkins Infrastructure

### Starting Jenkins Locally

The repository contains a self-contained Jenkins setup in the `jenkins/` directory.

**On Linux/MacOS:**
```bash
cd jenkins
docker compose up -d --build --force-recreate
```

**On Windows:**
```bash
cd jenkins
docker-compose up -d --build --force-recreate
```

Access Jenkins at http://localhost:8080 with credentials `admin`/`butler`.

### Prerequisites for Jenkins

Create a `.env` file in the project root with:
```bash
GITHUB_APP_ID=<your_github_app_id>
ANDROID_PUBLISHER_CREDENTIALS='<your_android_publisher_credentials>'
GITHUB_APP_KEY='<github_app_key>'
ADB_KEY='<your_adb_key>'
```

## Architecture

### Android Application Structure

- **Package**: `io.jenkins.mobile.example.myfirstbuiltbyjenkinsapplication`
- **Language**: Kotlin
- **Min SDK**: 21
- **Target SDK**: 33
- **Compile SDK**: 35
- **Architecture**: MVVM with Navigation Component
- **UI Fragments**:
  - `HomeFragment` / `HomeViewModel`
  - `GalleryFragment` / `GalleryViewModel`
  - `SlideshowFragment` / `SlideshowViewModel`

### Build Configuration

- **Android Gradle Plugin**: 8.8.0
- **Kotlin**: 2.1.0
- **Java Version**: 11
- **Versioning**: Semantic versioning using `com.dipien:semantic-version-android-gradle-plugin`
  - Version defined in root `build.gradle` (currently `1.1.11`)
  - Plugin auto-generates `versionCode` and `versionName` from semantic version

### Jenkins Pipeline Stages

The `Jenkinsfile` defines a complete CI/CD pipeline:

1. **Static Analysis** (parallel):
   - Gradle check (Detekt, SpotBugs, PMD, Lint)
   - Qodana analysis

2. **Compile and Code Coverage** (parallel):
   - Build APKs/AABs
   - Generate Jacoco coverage reports

3. **Security Check**: Placeholder for dependency checks

4. **Run Unit Tests**: Execute JUnit tests

5. **Run Instrumented Tests**:
   - Uses STF (Smartphone Test Farm) for device management
   - Connects to Android devices via ADB
   - Requires `stf-api-token` credential

6. **Publishing Artifacts** (parallel):
   - Archive APKs, AABs, and test reports
   - Publish HTML reports (Lint, Detekt, SpotBugs, Test results)
   - Trigger `PublishAppToGitHubAndGoogle` job

### Jenkins Agents

The pipeline uses two agent labels:
- `android`: For building and testing Android apps (uses custom Docker image `gounthar/jenkinsci-docker-android-base`)
- `docker`: For Docker-based tasks like Qodana

### Static Analysis Tools

- **Detekt**: Kotlin static analysis
- **SpotBugs**: Java bytecode analysis
- **PMD**: Source code analyzer
- **Lint**: Android-specific linting
- **Qodana**: JetBrains code quality platform

### Release Process

Uses `com.dipien:semantic-version-android-gradle-plugin` for versioning:
- Version suffix determines release type:
  - `ALPHA` or `BETA`: pre-release
  - `SNAPSHOT`: no release
  - `RELEASE`: production release
  - Other: draft release
- Automated GitHub releases via `gh` CLI
- Automated Google Play Store releases (internal track, draft status)
- Release notes auto-generated by GitHub CLI

### Docker Compose Services

Located in `jenkins/docker-compose.yml`:
- Jenkins controller
- Jenkins agents (Android build environment)
- ADB connector for device management
- Qodana for code analysis

### GitHub Actions

- **android.yml**: CI build on push/PR to main (uses JDK 17)
- **docker-image.yml**: Build and push Docker images
- **codacy.yml**: Codacy analysis
- **plugins-update.yml**: Update Jenkins plugins
- **release-drafter.yml**: Auto-generate release notes

## Important Files

- `Jenkinsfile`: Main CI/CD pipeline definition
- `app/build.gradle`: Android app build configuration with plugins and dependencies
- `build.gradle`: Root project configuration with semantic versioning
- `jenkins/docker-compose.yml`: Jenkins infrastructure definition
- `jenkins/create-release.sh`: GitHub release creation script
- `jenkins/create-gps-release.sh`: Google Play Store release script

## Development Notes

- The app uses View Binding (enabled in `app/build.gradle`)
- Signing configuration is defined for release builds (uses `my-release-key.jks`)
- Test framework: JUnit 4 for unit tests, Espresso for UI tests
- Navigation uses AndroidX Navigation Component
- The project follows conventional commits as per contributing guidelines
